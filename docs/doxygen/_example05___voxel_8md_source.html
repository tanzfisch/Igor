<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=9"/>
		<meta name="generator" content="Doxygen 1.8.8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>Igor: Example05_Voxel.md Source File</title>
		<link href="tabs.css" rel="stylesheet" type="text/css"/>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript" src="dynsections.js"></script>
		<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
		<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
		<link href="doxygen.css" rel="stylesheet" type="text/css" />
		<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="custom_dark_theme.css" rel="stylesheet" type="text/css"/>
	</head>
	<body>
	<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
		<div id="titlearea">
			<table cellspacing="0" cellpadding="0">
				<tbody>
					<tr>
						<td id="projectlogo">                        
                            <div style="position: relative; height: 120px; width: 440px;">
                                <div style="position: absolute; float: right; right: 30px; bottom: 10px; z-index: 1000; background-color: transparent;">0.20.0</div>
                                <img alt="Logo" src="logo.png"></img>                            
                            </div>
                        </td>                            
					</tr>
				</tbody>
			</table>
		</div>
		<!-- end header part --><!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_example05___voxel_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example05_Voxel.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_example05___voxel_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Voxel Terrain Example                                            {#example05}</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;=====================</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;So in the voxel example we basically learn two things. One is how to use the class iVoxelData and the other is how to write and register a model data loader that derives from iModelDataIO ([youtube](https://www.youtube.com/watch?v=EHBsmCx6gBM)).</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Build</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;=====</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;The code for this example can be found in the folder examples/05 Voxels. In a vs[ver] sub folder you will find a visual studio solution which contains example project but also all dependent projects. So you just open this one and than build and start. If everything went right you gonna see the following screen. If not please don&#39;t hesitate to contact [tanzfisch](https://github.com/tanzfisch).</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;![Voxel Example](/images/Example05_Pic1.png)</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;There is also a youtube clip [Voxel Example](https://youtu.be/EHBsmCx6gBM).</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;# Interaction</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;* click left and drag to rotate the camera around the point of interest</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;* press space to generate new voxel data</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;Code</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;====</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;The most interesting parts in this example happen in the method generateVoxelData() and the class VoxelTerrainMeshGenerator. We start with generateVoxelData() because it initiates everything.</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;So first thing is to alloc some memory for the voxel data by creating a iVoxelData obejct and initializing it with the size we need.</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        // if there is none create it</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        if (_voxelData == nullptr)</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        {</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;            _voxelData = new iVoxelData();</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;            // all voxels have a full density as default. so afterwars we need to cut holes in it</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;            _voxelData-&gt;setClearValue(255);</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;            _voxelData-&gt;initData(120, 120, 120);</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        }</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;We generate a new random base everytime so every time we hit the space button we get a diffrent result.</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        // generate new random base with time based seed</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        _perlinNoise.generateBase(static_cast&lt;uint32&gt;(iTimer::getInstance().getTime()));</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;Clear the voxel data and switch to uncompressed mode for faster access.</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        // clear the voxel data</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        _voxelData-&gt;clear();</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;Define some thresholds for metaballs and caves.</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        // define some threasholds to describe the surface of caves</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        const float64 from = 0.444;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        const float64 to = 0.45;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        float64 factor = 1.0 / (to - from);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        // define some threasholds to describe the surface of metaballs</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        const float64 fromMeta = 0.017;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        const float64 toMeta = 0.0175;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        float64 factorMeta = 1.0 / (toMeta - fromMeta);</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;Define some metaballs for the base structure</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        // define some metaballs</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        vector&lt;pair&lt;iaVector3f, float32&gt;&gt; metaballs;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        for (int i = 0; i &lt; 20; ++i)</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            metaballs.push_back(pair&lt;iaVector3f, float32&gt;(iaVector3f(rand() % static_cast&lt;int&gt;(_voxelData-&gt;getWidth() * 0.6) + (_voxelData-&gt;getWidth() * 0.2),</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                rand() % static_cast&lt;int&gt;(_voxelData-&gt;getHeight()*0.6) + (_voxelData-&gt;getHeight()* 0.2),</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                rand() % static_cast&lt;int&gt;(_voxelData-&gt;getDepth()*0.6) + (_voxelData-&gt;getDepth()*0.2)), (((rand() % 90) + 10) / 100.0) + 0.6));</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        }</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;Now we itereate through and figure out if they are inside the metaballs and if that is true also if they are inside a cave. </div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        // now iterate through all the voxels and define their density</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        for (int64 x = 0; x &lt; _voxelData-&gt;getWidth(); ++x)</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            for (int64 y = 0; y &lt; _voxelData-&gt;getHeight(); ++y)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            {</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                for (int64 z = 0; z &lt; _voxelData-&gt;getDepth(); ++z)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;                {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                    // first figure out if a voxel is outside the sphere</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                    iaVector3f pos(x, y, z);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                    float32 distance = 0;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                    for (auto metaball : metaballs)</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                    {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                        distance += metaballFunction(metaball.first, pos) * metaball.second;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                    }</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                    if (distance &lt;= toMeta)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                    {</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                        if (distance &gt;= fromMeta)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                        {</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                            // at the edge of the sphere.</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                            // now we can use the fractional part of the distance to determine how much more than a full voxel we are away from the center</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                            // and use this to set the density. this way we get a smooth sphere.</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                            float32 denstity = ((distance - fromMeta) * factorMeta);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                            // the density by the way goes from 0-255 but the zero is interpreted as outside ans the 1 is inside but with zero density</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                            // so to calculate a propper density we need to multiply the density with 254 and to make it alwasy beein &quot;inside&quot; we add one</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                            _voxelData-&gt;setVoxelDensity(iaVector3I(x, y, z), (denstity * 254) + 1);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                        }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                        else</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                        {</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                            // outside metaball</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                            _voxelData-&gt;setVoxelDensity(iaVector3I(x, y, z), 0);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                        }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                    }</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                    // using some perline noise to cut holes in the sphere. this time we skip the smoothing part due to much effort and cluttering the tutorial </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                    // with bad understandable code. Ask the author if you&#39;d like to know about smoothing the values</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                    float64 onoff = _perlinNoise.getValue(iaVector3d(pos._x * 0.03, pos._y * 0.03, pos._z * 0.03), 4, 0.5);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                    // we do the same here as with the metaball surface so it a pears a little smoother</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                    if (onoff &lt;= from)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                    {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                        if (onoff &gt;= to)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                        {</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                            float64 gradient = 1.0 - ((onoff - from) * factor);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                            _voxelData-&gt;setVoxelDensity(iaVector3I(x, y, z), (gradient * 254) + 1);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                        }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                        else</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                        {</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                            _voxelData-&gt;setVoxelDensity(iaVector3I(x, y, z), 0);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                        }</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                    }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                }</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;The next major part is to turn the voxel data in to a mesh. We could just use the class iContouringCubes to do that but fore more comfort and to understand how to use it we go for implementing the iModelDataIO interface. The iModelDataIO interface is kind of a hock within the engine&#39;s loading process. We can define basically our own model data type, register it to the loading process and later just initialize an iNodeModel with our voxel data instead of a filename.</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;So let&#39;s have a look at the key part of the VoxelTerrainMeshGenerator which implements that interface.</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    iNode* VoxelTerrainMeshGenerator::importData(const iaString&amp; sectionName, iModelDataInputParameter* parameter)</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    {</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;As you see we get besides the filename, which in our case is just any string, some extra input parameter that contain our voxel data information. See further down to initialize it with custom data.</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        TileInformation* tileInformation = reinterpret_cast&lt;TileInformation*&gt;(parameter-&gt;_parameters.getDataPointer());</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        iVoxelData* voxelData = tileInformation-&gt;_voxelData;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        int64 width = voxelData-&gt;getWidth() - 1;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        int64 depth = voxelData-&gt;getDepth() - 1;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        int64 height = voxelData-&gt;getHeight() - 1;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;We create a resulting group node because the engine expects this from us.</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        iNode* result = iNodeFactory::getInstance().createNode(iNodeType::iNode);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;Now we use the iContouringCubes class to turn our voxel data in to a mesh.</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        iContouringCubes contouringCubes;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        contouringCubes.setVoxelData(voxelData);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        shared_ptr&lt;iMesh&gt; mesh = contouringCubes.compile(iaVector3I(), iaVector3I(width, height, depth));</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;Theoretically the voxel data could result in a mesh that does not exists so we have to check that here.</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        if (mesh.get() != nullptr)</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;But if it does exist we create a iNodeMesh and add it to the resulting node.</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            iNodeMesh* meshNode = static_cast&lt;iNodeMesh*&gt;(iNodeFactory::getInstance().createNode(iNodeType::iNodeMesh));</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            meshNode-&gt;setMesh(mesh);</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            meshNode-&gt;setMaterial(tileInformation-&gt;_materialID);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;We also set up the target material of our mesh for tri planar texture mapping as defined earlier in material _voxelMeshMaterialID.</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            iTargetMaterial* targetMaterial = meshNode-&gt;getTargetMaterial();</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            targetMaterial-&gt;setTexture(iTextureResourceFactory::getInstance().requestFile(&quot;dirt.png&quot;), 0);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            targetMaterial-&gt;setTexture(iTextureResourceFactory::getInstance().requestFile(&quot;grass.png&quot;), 1);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            targetMaterial-&gt;setTexture(iTextureResourceFactory::getInstance().requestFile(&quot;rock.png&quot;), 2);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            targetMaterial-&gt;setAmbient(iaColor3f(0.7f, 0.7f, 0.7f));</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            targetMaterial-&gt;setDiffuse(iaColor3f(0.9f, 0.9f, 0.9f));</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            targetMaterial-&gt;setSpecular(iaColor3f(0.1f, 0.1f, 0.1f));</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            targetMaterial-&gt;setEmissive(iaColor3f(0.01f, 0.01f, 0.01f));</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            targetMaterial-&gt;setShininess(100.0f);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            result-&gt;insertNode(meshNode);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        }</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        return result;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    }</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;And last but not least here is how we initialize our custom input parameters for loading our voxel data as a mesh iModelDataInputParameter.</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    // prepar special tile information for the VoxelTerrainMeshGenerator</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    TileInformation tileInformation;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    tileInformation._materialID = _voxelMeshMaterialID;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    tileInformation._voxelData = _voxelData;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    // define the input parameter so Igor knows which iModelDataIO implementation to use and how</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    iModelDataInputParameter* inputParam = new iModelDataInputParameter();</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    inputParam-&gt;_identifier = &quot;vtg&quot;;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    inputParam-&gt;_joinVertexes = true;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    inputParam-&gt;_needsRenderContext = false;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    inputParam-&gt;_modelSourceType = iModelSourceType::Generated;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    inputParam-&gt;_loadPriority = 0;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    inputParam-&gt;_parameters.setData(reinterpret_cast&lt;const char*&gt;(&amp;tileInformation), sizeof(TileInformation));</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    // create a model node</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    iNodeModel* voxelMeshModel = static_cast&lt;iNodeModel*&gt;(iNodeFactory::getInstance().createNode(iNodeType::iNodeModel));</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    _voxelMeshModel = voxelMeshModel-&gt;getID();</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    // tell the model node to load data with specified identifier ans the above defined parameter</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    // it is important to have a unique identifier each time we generate a mesh otherwhise the cache system would return us a prvious generated mesh</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    voxelMeshModel-&gt;setModel(iaString(&quot;VoxelMesh&quot;) + iaString::itoa(_incarnation++), inputParam);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    // create a transform node to center the mesh to the origin</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    iNodeTransform* voxelMeshTransform = static_cast&lt;iNodeTransform*&gt;(iNodeFactory::getInstance().createNode(iNodeType::iNodeTransform));</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    _voxelMeshTransform = voxelMeshTransform-&gt;getID();</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    voxelMeshTransform-&gt;translate(-_voxelData-&gt;getWidth() / 2, -_voxelData-&gt;getHeight() / 2, -_voxelData-&gt;getDepth() / 2);</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    // and add to scene</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    voxelMeshTransform-&gt;insertNode(voxelMeshModel);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    _scene-&gt;getRoot()-&gt;insertNode(voxelMeshTransform);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;Additional Information</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;======================</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;Since the engine is capable of double precision size worlds we need to do an additional step that is kind of a workaround. At the bottom of the init method you can find the following lines.</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    // ok this one is kind of a workaround. In order to handle huge worlds beyond float precision we internally mess around with world positions.</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    // in consequence the world positions that end up in the shader are not valid. They are relative to the camera position. To compensate we can </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    // set the world grid resolution here. It basically makes a modulo on the world coordinates so they never exceed float precision and are sort of usable again within a shader.</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    iRenderer::getInstance().setWorldGridResolution(1000.0);</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;And that&#39;s it. For further questions please contact [tanzfisch](https://github.com/tanzfisch).</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
		<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
			<ul>
				<li class="navelem"><a class="el" href="_example05___voxel_8md.html">Example05_Voxel.md</a></li>
				<li class="footer">
					Generated on Sat May 25 2019 16:07:59 for Igor by <a href="http://www.doxygen.org/index.html">
					<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8.
					Dark theme by <a href="http://majerle.eu" target="_new">Tilen Majerle</a>. All rights reserved.
				</li>
			</ul>
		</div>
		<script src="custom.js"></script>
	</body>
</html>